<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>家計簿</title>
  <script>
  // スマホ判定（幅600px未満ならmobile.htmlへ）
  if (window.innerWidth < 600) {
    window.location.href = "mobile.html";
  }
  </script>
  <style>
body {
  font-family: sans-serif;
  padding: 20px;
}

h1, h2 {
  margin-bottom: 16px;
}

label {
  font-weight: bold;
}

/* 日付行 */
.date-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.date-row label {
  min-width: 50px;
  text-align: right;
}

.date-row input[type="date"] {
  width: 120px;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* 日付入力欄とカテゴリ入力欄の間の余白を調整 */
#datepicker {
  margin-bottom: 12px; 
}

/* カテゴリ・テキスト・支払者行 */
.form2 {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
}

.form2 label {
  min-width: 60px;
  text-align: right;
}

.form2 input,
.form2 select {
  width: 140px;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* 金額入力行 */
.money-group {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
  font-size: 14px;
}

.money-group div {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.money-group label {
  text-align: left;
  margin-bottom: 2px;
}

.money-group input {
  width: 80px;
  padding: 4px 6px;
  text-align: right;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* ボタン行 */
.bottan {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

button {
  padding: 6px 12px;
  border: 1px solid #888;
  border-radius: 4px;
  background-color: #f0f0f0;
  cursor: pointer;
}

button:hover {
  background-color: #e0e0e0;
}

/* ====== 家計簿テーブル（色分け） ====== */
table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 12px;
  text-align: left;
}

th {
  color: #333;
  font-weight: bold;
}

/* 年月～支払者（黄緑） */
#kakeiTable th:nth-child(1),
#kakeiTable th:nth-child(2),
#kakeiTable th:nth-child(3),
#kakeiTable th:nth-child(4) {
  background-color: #ccffcc;
}

/* 収入系（黄色） */
#kakeiTable th:nth-child(5) {
  background-color: #fff6a4;
}

/* それ以降（水色系） */
#kakeiTable th:nth-child(n+6) {
  background-color: #cce5ff;
}

/* ====== 家計簿(固定費）テーブル（色分け） ====== */

/* 年月～支払者（黄緑） */
#koteiTable th:nth-child(1),
#koteiTable th:nth-child(2),
#koteiTable th:nth-child(3),
#koteiTable th:nth-child(4) {
  background-color: #ccffcc;
}

/* 収入系（黄色） */
#koteiTable th:nth-child(5) {
  background-color: #fff6a4;
}

/* それ以降（水色系） */
#koteiTable th:nth-child(n+6) {
  background-color: #cce5ff;
}


/* ====== 個人負担表＆合計表並び ====== */
.table-row {
  display: flex;
  gap: 30px;
  align-items: stretch;
  margin-bottom: 30px; 
}

/* 個人負担表 */
#burdenTable {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  border: 1px solid #ccc;
}

#burdenTable th,
#burdenTable td {
  white-space: nowrap;
  border: 1px solid #ccc;
  padding: 3px 12px;
  text-align: left;
}

#burdenTable thead {
  background-color: #c8e6c9; /* 緑系 */
  color: #1b5e20;
}

/* 個人負担表：精算済み行をセル単位でグレーアウト */
#burdenTable tbody tr.settled-row td {
  background-color: #e0e0e0 !important; 
  color: #666 !important;
}

/* ====== ✅ 合計表ヘッダー（ここが追加ポイント） ====== */
#totalTable thead th:nth-child(1) {
  background-color: #fff6a4; /* 収入系（黄色） */
}

#totalTable thead th:nth-child(2) {
  background-color: #cce5ff; /* 食事関係（水色） */
}

#totalTable thead th:nth-child(3) {
  background-color: #cce5ff; /* 雑貨・生活用品系（水色） */
}

#totalTable thead th:nth-child(4) {
  background-color: #cce5ff; /* 遊び・娯楽関係（水色） */
}

#totalTable thead th:nth-child(5) {
  background-color: #cce5ff; /* 生活費関係（水色） */
}

#totalTable thead th:nth-child(6) {
  background-color: #cce5ff; /* 子供・教育（水色） */
}

#totalTable thead th:nth-child(7) {
  background-color: #cce5ff; /* その他（水色） */
}

#totalTable thead th:nth-child(8) {
  background-color: #ffe0b2; /* 収支（目立たせる淡いオレンジ） */
  color: #5d4037;
  font-weight: bold;
}

#totalTable th {
  border: 1px solid #d7b87b;
}

/* テーブル比率 */
#burdenTable {
  flex: 0 0 30%;
}
#totalTable {
  flex: 1;
}

/* メッセージ */
#message {
  color: red;
  font-weight: bold;
}

/* ▼ セルの見た目（白背景を統一） */
#burdenTable td,
#totalTable td ,
#kakeiTable td {
  background-color: #ffffff; /* 白背景 */
  border: 1px solid #ddd;
  padding: 1px 12px;
  text-align: left;
}

/* 家計簿内容テーブルのスクロールエリア */
.table-scroll {
  max-height: 400px;   /* スクロール高さ上限 */
  overflow-y: auto;
  overflow-x: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #fff;
  margin-top: 0;       /* 余白を完全に */
  padding-top: 0;
}

/* テーブル自体の余白を削除 */
.table-scroll table {
  border-collapse: collapse;
  margin: 0;
}

/* スクロールしてもヘッダー固定 */
.table-scroll thead th {
  position: sticky;
  top: 0;                    /* ヘッダー固定 */
  background-color: inherit; /* 既存のヘッダー色を保持 */
  z-index: 2;
  border-bottom: 2px solid #999;
}

/* 偶数行の背景で見やすく */
.table-scroll tbody tr:nth-child(even) {
  background-color: #fafafa;
}

/* 変動費・固定費チェック */
.cost-type {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 8px;
  font-size: 14px;
}

.cost-type label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-weight: normal;
}

h2, h3, h4 {
  margin-top: 2px;      /* 上の余白を小さく */
  margin-bottom: 3px;   /* 下の余白も詰める */
  padding: 0;           /* 念のためリセット */
  line-height: 1.2;
}

h2 {
  font-size: 20px;
  color: #333;
  border-left: 6px solid #4caf50;
  padding-left: 8px;
}

h3, h4 {
  font-size: 20px;
  color: #444;
}

.table-row {
  display: flex;
  gap: 30px;
  align-items: flex-start; /* 各ブロックの上端を揃える */
  margin-bottom: 30px;
}

.table-block {
  flex: 1;
}

.table-row .table-block h4 {
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
  font-size: 18px;
  color: #333;
  line-height: 1.1;
}

.gray-cell {
  background-color: #e0e0e0;
  color: #777;
}

/* 固定費表 (#koteiTable) の行高さと背景色を統一 */

/* 1行あたりの高さを変動費表と合わせる（例：28px程度） */
#koteiTable tbody td {
  height: 18px; /* 必要に応じて調整（変動費表に合わせる） */
  padding-top: 4px;
  padding-bottom: 4px;
}

/* 奇数・偶数行の背景色を統一（白で固定） */
#koteiTable tbody tr:nth-child(even),
#koteiTable tbody tr:nth-child(odd) {
  background-color: #ffffff !important;
}


  </style>
</head>

<body>
  <h1>家計簿入力</h1>
  
<!-- 変動費・固定費ラジオボタン -->
<div class="cost-type">
  <label><input type="radio" name="costType" id="variableCost" value="variable" checked> 変動費</label>
  <label><input type="radio" name="costType" id="fixedCost" value="fixed"> 固定費</label>
</div>

<form id="kakeiboForm" class="form">
 
    <label for="datepicker">日付</label>
    <input type="date" id="datepicker">

 <div class="form2">
    <label for="category">カテゴリ</label>
    <select id="category"><option value="">読み込み中...</option>
    </select>

    <label for="text">テキスト</label>
    <input type="text" id="text">

    <label for="payer">支払者</label>
    <select id="payer"><option value="">読み込み中...</option>
    </select>
 </div>

 <div class="money-group">
 <div><label for="money">収入</label><input type="number" id="income" placeholder=0></div>
 <div><label for="money">食費</label><input type="number" id="meal" placeholder=0></div>
 <div><label for="money">生活用品</label><input type="number" id="supplies" placeholder=0></div>
 <div><label for="money">娯楽</label><input type="number" id="play" placeholder=0></div>
 <div><label for="money">生活費</label><input type="number" id="infra" placeholder=0></div>
 <div><label for="money">子供・教育</label><input type="number" id="education" placeholder=0></div>
 <div><label for="money">その他</label><input type="number" id="others" placeholder=0></div>
 </div>

 <p id="message"></p>

 <div class="bottan">
    <button type="submit">登録</button>
    <button type="button" id="clearButton">クリア</button>
    <button onclick="location.href='./categoryset.html'">カテゴリメンテナンス</button>
    <button onclick="location.href='./payerset.html'">支払者メンテナンス</button>
 </div>
</form>

  <h2>家計簿内容</h2>
  <div style="margin-bottom: 10px;">
    <button id="prevMonth">◀ 前月</button>
    <input type="month" id="datemonth" name="example" min="1801-01" max="2999-12">
    <button id="nextMonth">翌月 ▶</button>
  </div>

<div class="table-row">
  <div class="table-block">
    <table id="burdenTable">
      <thead>
        <tr>
          <th>支払者</th>
          <th>金額</th>
          <th>精算済</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-block">
    <table id="totalTable">
      <thead>
        <tr>
          <th>収入合計</th>
          <th>食事関係</th>
          <th>雑貨・生活用品系</th>
          <th>遊び・娯楽関係</th>
          <th>生活費関係</th>
          <th>子供・教育</th>
          <th>その他</th>
          <th>収支</th>        
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>



<h3>固定費</h3>
<div style="margin-top: 10px; margin-bottom: 5px;">
  <button id="koteieditSelected">修正</button>
  <button id="koteideleteSelected">削除</button>
</div>
<div class="table-scroll">
  <table id="koteiTable">
    <thead>
      <tr>
        <th class="checkbox">選択</th>
        <th>年月</th>
        <th>カテゴリ</th>
        <th>備考</th>
        <th>支払者</th>
        <th>収入系</th>
        <th>食事関係</th>
        <th>雑貨・生活用品系</th>
        <th>遊び・娯楽関係</th>
        <th>生活費関係</th>
        <th>子供・教育</th>
        <th>その他</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<h3>変動費</h3>
<div style="margin-top: 10px; margin-bottom: 5px;">
  <button id="editSelected">修正</button>
  <button id="deleteSelected">削除</button>
</div>
<div class="table-scroll">
  <table id="kakeiTable">
    <thead>
      <tr>
        <th class="checkbox">選択</th>
        <th>年月</th>
        <th>カテゴリ</th>
        <th>備考</th>
        <th>支払者</th>
        <th>収入系</th>
        <th>食事関係</th>
        <th>雑貨・生活用品系</th>
        <th>遊び・娯楽関係</th>
        <th>生活費関係</th>
        <th>子供・教育</th>
        <th>その他</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://gyogtttxgenbgpryclcr.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5b2d0dHR4Z2VuYmdwcnljbGNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDYxMDEsImV4cCI6MjA3NjUyMjEwMX0.MUemu4Y1Qu4Zm0aN29dwNoLg2n51VorJvxTeaf62Pvw'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const form = document.getElementById('kakeiboForm')
    const message = document.getElementById('message')
    const categorySelect = document.getElementById('category')
    const payerSelect = document.getElementById('payer')
    const koteiBody = document.querySelector('#koteiTable tbody')
    const kakeiBody = document.querySelector('#kakeiTable tbody')
    const totalBody = document.querySelector('#totalTable tbody')
    const monthInput = document.getElementById('datemonth')
    let editTarget = null; // 編集中の {date, seq} を保持
    

    // カテゴリ選択肢を Supabase から読み込む
    async function loadCategories() {
    
      let data, error;

      if (document.getElementById('variableCost').checked === true) {
       ({ data, error } = await supabase
        .from('category')
        .select('categoryid, categoryname')
        .order('categoryid', { ascending: true }));
      } else if (document.getElementById('fixedCost').checked === true) { 
       ({ data, error } = await supabase
        .from('infra_category')
        .select('categoryid, categoryname')
        .order('categoryid', { ascending: true }));
      }

      if (error) {
        console.error(error)
        message.textContent = 'カテゴリ読み込みエラー: ' + error.message
        categorySelect.innerHTML = '<option value="">読み込み失敗</option>';
        return;
      }

      categorySelect.innerHTML = '<option value="">選択してください</option>';
      data.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.categoryid // IDを値にする
        option.textContent = cat.categoryname // 表示名
        categorySelect.appendChild(option)
      });
    }
    
    loadCategories();

    // ラジオボタン切り替え時にカテゴリを再読み込み
    document.querySelectorAll('input[name="costType"]').forEach(radio => {
     radio.addEventListener('change', async () => {
     await loadCategories();
     });
    });


    // 支払者選択肢を Supabase から読み込む
    async function loadpayers() {
      const { data, error } = await supabase
        .from('payer')
        .select('payerid, payername')
        .order('payerid', { ascending: true });
     
      if (error) {
        console.error(error)
        message.textContent = '支払者読み込みエラー: ' + error.message
        payerSelect.innerHTML = '<option value="">読み込み失敗</option>';
        return;
      }

      payerSelect.innerHTML = '<option value="">選択してください</option>';
      data.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.payerid // IDを値にする
        option.textContent = cat.payername // 表示名
        payerSelect.appendChild(option)
      });
    }
    
    loadpayers();
    
    
    // id取得
    async function getNextIdForDate(date) {
     const { data, error } = await supabase
     .from('kakei')
     .select('seq')
     .eq('date', date)
     .order('seq', { ascending: false })
     .limit(1); 
    
     if (error) {
      console.error(error)
      message.textContent =  'ID取得エラー: ' + error.message
      return 1;
     } 
    return data && data.length > 0 ? data[0].seq + 1 : 1;
   }
  
    // 固定費フラグ判断
    async function getfixedcostflg() {
    const selected = document.querySelector('input[name="costType"]:checked')?.value;
    return selected === 'fixed' ? 2 : 1;
   }
    
    // 合計値表示
    async function totalkakei(selectedMonth = null) {
      let query = supabase.from('total_expenditure').select('*').order('year_month', { ascending: true });
    
      if (selectedMonth) {
      const [year, month] = selectedMonth.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0]
      const endDate = new Date(year, month, 0).toISOString().split('T')[0]
    
      query = query.gte('year_month', startDate).lte('year_month', endDate);
      }
    
      const { data, error } = await query;
       
      if (error) {
        console.error(error)
        message.textContent = 'テーブル読み込みエラー: ' + error.message
        return;
      }
    
    totalBody.innerHTML = '';
    
      data.forEach(row => {
        const tr = document.createElement('tr');
    

        // 収入系
        const income_total= document.createElement('td');
        const income_totalValue = Number(row.income_total); 
        income_total.textContent = isNaN(income_totalValue)
        ? '' 
        : income_totalValue.toLocaleString('ja-JP'); 

        // 食事合計
        const meal_total= document.createElement('td');
        const meal_totalValue = Number(row.meal_total); 
        meal_total.textContent = isNaN(meal_totalValue)
        ? '' 
        : meal_totalValue.toLocaleString('ja-JP'); 

        // 雑貨・生活用品合計
        const supplies_total= document.createElement('td');
        const supplies_totalValue = Number(row.supplies_total); 
        supplies_total.textContent = isNaN(supplies_totalValue)
        ? '' 
        : supplies_totalValue.toLocaleString('ja-JP'); 

        // 遊び・娯楽系合計
        const play_total= document.createElement('td');
        const play_totalValue = Number(row.play_total); 
        play_total.textContent = isNaN(play_totalValue)
        ? '' 
        : play_totalValue.toLocaleString('ja-JP'); 

        // 生活費関係合計
        const infra_total= document.createElement('td');
        const infra_totalValue = Number(row.infra_total); 
        infra_total.textContent = isNaN(infra_totalValue)
        ? '' 
        : infra_totalValue.toLocaleString('ja-JP'); 

        // 子供・教育合計
        const education_total= document.createElement('td');
        const education_totalValue = Number(row.education_total); 
	        education_total.textContent = isNaN(education_totalValue)
	        ? '' 
        : education_totalValue.toLocaleString('ja-JP'); 

        // その他合計
        const others_total= document.createElement('td');
        const others_totalValue = Number(row.others_total); 
        others_total.textContent = isNaN(others_totalValue)
        ? '' 
        : others_totalValue.toLocaleString('ja-JP'); 
        
        // 収支
        const expenditure= document.createElement('td');
        const expenditureValue = Number(row.expenditure); 
        
        if (isNaN(expenditureValue)) {
          expenditure.textContent = '';
        } else {
          expenditure.textContent = expenditureValue.toLocaleString('ja-JP');
          // マイナスのとき赤字
          if (expenditureValue < 0) {
           expenditure.style.color = 'red';
           expenditure.style.fontWeight = 'bold';
          } else {
           expenditure.style.color = 'black';
          }
         }
        
        
        
        tr.appendChild(income_total);
        tr.appendChild(meal_total);
        tr.appendChild(supplies_total);
        tr.appendChild(play_total);
        tr.appendChild(infra_total);
        tr.appendChild(education_total);
        tr.appendChild(others_total);
        tr.appendChild(expenditure);
        totalBody.appendChild(tr);
    });
    }
    
    // 家計簿(固定費)内容表示
    async function loadkoteikakei(selectedMonth = null) {
      let query = supabase.from('kakeicontent').select('*').eq('fixedcostflg', 2).order('date', { ascending: true });
    
      if (selectedMonth) {
      const [year, month] = selectedMonth.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0]
      const endDate = new Date(year, month, 0).toISOString().split('T')[0]
    
      query = query.gte('date', startDate).lte('date', endDate);
      }
    
      const { data, error } = await query;
       
      if (error) {
        console.error(error)
        message.textContent = 'テーブル読み込みエラー: ' + error.message
        return;
      }
    
    koteiBody.innerHTML = '';
    
      data.forEach(row => {
        const tr = document.createElement('tr');

        // チェックボックス
        const tdCheck = document.createElement('td');
        tdCheck.className = 'checkbox';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.date = row.date;
        checkbox.dataset.seq = row.seq;
        tdCheck.appendChild(checkbox);

        // 年月
        const tddate = document.createElement('td');
        tddate.textContent = row.date;
        
        // カテゴリ
        const tdcategoryname= document.createElement('td');
        tdcategoryname.textContent = row.categoryname;

        // 備考
        const tdcontent= document.createElement('td');
        tdcontent.textContent = row.content;
        
        // 支払者
        const tdpayername= document.createElement('td');
        tdpayername.textContent = row.payername;
        
        // 食事関係
        const tdmeal= document.createElement('td');
        const mealValue = Number(row.meal); 
        tdmeal.textContent = isNaN(mealValue)
        ? '' 
        : mealValue.toLocaleString('ja-JP'); 

        // 収入系
        const tdincome= document.createElement('td');
        const incomeValue = Number(row.income); 
        tdincome.textContent = isNaN(incomeValue)
        ? '' 
        : incomeValue.toLocaleString('ja-JP'); 

        // 雑貨・生活用品系
        const tdsupplies= document.createElement('td');
        const suppliesValue = Number(row.supplies); 
        tdsupplies.textContent = isNaN(suppliesValue)
        ? '' 
        : suppliesValue.toLocaleString('ja-JP'); 

        // 遊び・娯楽系
        const tdplay= document.createElement('td');
        const playValue = Number(row.play); 
        tdplay.textContent = isNaN(playValue)
        ? '' 
        : playValue.toLocaleString('ja-JP'); 

        // 生活費関係
        const tdinfra= document.createElement('td');
        const infraValue = Number(row.infra); 
        tdinfra.textContent = isNaN(infraValue)
        ? '' 
        : infraValue.toLocaleString('ja-JP'); 

        // 子供・教育
        const tdeducation= document.createElement('td');
        const educationValue = Number(row.education); 
        tdeducation.textContent = isNaN(educationValue)
        ? '' 
        : educationValue.toLocaleString('ja-JP'); 

        // その他
        const tdothers= document.createElement('td');
        const othersValue = Number(row.others); 
        tdothers.textContent = isNaN(othersValue)
        ? '' 
        : othersValue.toLocaleString('ja-JP'); 
        
        tr.appendChild(tdCheck);
        tr.appendChild(tddate);
        tr.appendChild(tdcategoryname);
        tr.appendChild(tdcontent);
        tr.appendChild(tdpayername);
        tr.appendChild(tdincome);
        tr.appendChild(tdmeal);
        tr.appendChild(tdsupplies);
        tr.appendChild(tdplay);
        tr.appendChild(tdinfra);
        tr.appendChild(tdeducation);
        tr.appendChild(tdothers);
        koteiBody.appendChild(tr);
        
        
    });
     /* 0のセルをグレーアウト */
     const rows = koteiBody.querySelectorAll("tr");
     rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      const remarksCell = cells[3];
      if (remarksCell) {
       remarksCell.classList.add("gray-cell");
      }

      for (let i = 5; i <= 11; i++) {
       const cell = cells[i];
       if (!cell) continue;
        const value = cell.textContent.replace(/,/g, '').trim();
        if (value === "" || value === "0") {
         cell.classList.add("gray-cell");
        }
       }
      });
    }


    
    // 家計簿(変動費)内容表示
    async function loadkakei(selectedMonth = null) {
      let query = supabase.from('kakeicontent').select('*').eq('fixedcostflg', 1).order('date', { ascending: true });
    
      if (selectedMonth) {
      const [year, month] = selectedMonth.split('-').map(Number);
      const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0]
      const endDate = new Date(year, month, 0).toISOString().split('T')[0]
    
      query = query.gte('date', startDate).lte('date', endDate);
      }
    
      const { data, error } = await query;
       
      if (error) {
        console.error(error)
        message.textContent = 'テーブル読み込みエラー: ' + error.message
        return;
      }
    
    kakeiBody.innerHTML = '';
    
      data.forEach(row => {
        const tr = document.createElement('tr');

        // チェックボックス
        const tdCheck = document.createElement('td');
        tdCheck.className = 'checkbox';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.date = row.date;
        checkbox.dataset.seq = row.seq;
        tdCheck.appendChild(checkbox);

        // 年月
        const tddate = document.createElement('td');
        tddate.textContent = row.date;
        
        // カテゴリ
        const tdcategoryname= document.createElement('td');
        tdcategoryname.textContent = row.categoryname;
        
        // 備考
        const tdcontent= document.createElement('td');
        tdcontent.textContent = row.content;
        
        // 支払者
        const tdpayername= document.createElement('td');
        tdpayername.textContent = row.payername;
        
        // 収入系
        const tdincome= document.createElement('td');
        const incomeValue = Number(row.income); 
        tdincome.textContent = isNaN(incomeValue)
        ? '' 
        : incomeValue.toLocaleString('ja-JP'); 

        // 食事関係
        const tdmeal= document.createElement('td');
        const mealValue = Number(row.meal); 
        tdmeal.textContent = isNaN(mealValue)
        ? '' 
        : mealValue.toLocaleString('ja-JP'); 

        // 雑貨・生活用品系
        const tdsupplies= document.createElement('td');
        const suppliesValue = Number(row.supplies); 
        tdsupplies.textContent = isNaN(suppliesValue)
        ? '' 
        : suppliesValue.toLocaleString('ja-JP'); 

        // 遊び・娯楽系
        const tdplay= document.createElement('td');
        const playValue = Number(row.play); 
        tdplay.textContent = isNaN(playValue)
        ? '' 
        : playValue.toLocaleString('ja-JP'); 

        // 生活費関係
        const tdinfra= document.createElement('td');
        const infraValue = Number(row.infra); 
        tdinfra.textContent = isNaN(infraValue)
        ? '' 
        : infraValue.toLocaleString('ja-JP'); 

        // 子供・教育
        const tdeducation= document.createElement('td');
        const educationValue = Number(row.education); 
        tdeducation.textContent = isNaN(educationValue)
        ? '' 
        : educationValue.toLocaleString('ja-JP'); 

        // その他
        const tdothers= document.createElement('td');
        const othersValue = Number(row.others); 
        tdothers.textContent = isNaN(othersValue)
        ? '' 
        : othersValue.toLocaleString('ja-JP'); 
        
        tr.appendChild(tdCheck);
        tr.appendChild(tddate);
        tr.appendChild(tdcategoryname);
        tr.appendChild(tdcontent);
        tr.appendChild(tdpayername);
        tr.appendChild(tdincome);
        tr.appendChild(tdmeal);
        tr.appendChild(tdsupplies);
        tr.appendChild(tdplay);
        tr.appendChild(tdinfra);
        tr.appendChild(tdeducation);
        tr.appendChild(tdothers);
        kakeiBody.appendChild(tr);
        
        
    });
    }
    
    //個人負担チェックテーブル初期表示処理
    async function ensureMonthlySettledRecords(selectedMonth) {
     // payerテーブルから全payeridを取得
     const { data: payers, error: payerError } = await supabase
      .from('payer')
      .select('payerid');
    
     if (payerError) {
      console.error('payer取得エラー:', payerError);
      return;
     }
    
    if (!payers || payers.length === 0) return;
    
     // monthly_settledテーブルにすでに存在するpayeridを取得
     const { data: existing, error: existingError } = await supabase
      .from('monthly_settled')
      .select('payerid')
      .eq('year_month', selectedMonth);

     if (existingError) {
      console.error('monthly_settled既存取得エラー:', existingError);
      return;
     }
    
    const existingIds = new Set(existing.map(r => r.payerid));
    
    // 挿入が必要なpayeridだけを抽出
    const toInsert = payers
     .filter(p => !existingIds.has(p.payerid))
     .map(p => ({
       payerid: p.payerid,
       year_month: selectedMonth,
       settled: false
     }));
    
    // 挿入
    if (toInsert.length > 0) {
     const { data, error } = await supabase
      .from('monthly_settled')
      .insert(toInsert);

    if (error) {
       console.error('monthly_settled挿入エラー:', error);
    } else {
      console.log('monthly_settledに追加:', data);
    }
  }
  }

async function loadBurdenTable(selectedMonth = null) {
  if (!selectedMonth) {
    const now = new Date();
    selectedMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }

  const { data, error } = await supabase
    .from('monthly_burden')
    .select('*')
    .eq('year_month', selectedMonth);

  if (error) {
    console.error('データ取得エラー', error);
    return;
  }

  const tbody = document.querySelector('#burdenTable tbody');
  tbody.innerHTML = '';

  data.forEach(row => {
    const tr = document.createElement('tr');

    // ここで既にsettled済みならクラス追加（再読み込み時にも反映）
    if (row.settled) tr.classList.add('settled-row');

    const tdName = document.createElement('td');
    tdName.textContent = row.payername;

    const tdTotal = document.createElement('td');
    tdTotal.textContent = row.total_sum.toLocaleString('ja-JP');

    const tdCheckbox = document.createElement('td');
    tdCheckbox.classList.add('checkbox');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = row.settled;

    // ✅ チェック変更イベント
    checkbox.addEventListener('change', async () => {
      if (checkbox.checked) {
        tr.classList.add('settled-row');
      } else {
        tr.classList.remove('settled-row');
      }

      // DB更新
      const { error: updateError } = await supabase
        .from('monthly_settled')
        .update({ settled: checkbox.checked })
        .eq('payerid', row.payerid)
        .eq('year_month', selectedMonth);

      if (updateError) console.error('更新エラー', updateError);
    });

    tdCheckbox.appendChild(checkbox);
    tr.appendChild(tdName);
    tr.appendChild(tdTotal);
    tr.appendChild(tdCheckbox);

    tbody.appendChild(tr);
  });
}

    
    // ページ初期表示
    async function init() {
     const now = new Date();
     const year = now.getFullYear();
     const month = String(now.getMonth() + 1).padStart(2, '0');
     const currentMonth = `${year}-${month}`;
     document.getElementById('datemonth').value = currentMonth
     await totalkakei(currentMonth);
     await loadkoteikakei(currentMonth);
     await loadkakei(currentMonth);
     ensureMonthlySettledRecords(currentMonth);
     loadBurdenTable(currentMonth);
    }
    
    init();
    
    // 月変更時にテーブル再読み込み
    document.getElementById('datemonth').addEventListener('change', async (e) => {
    const selectedMonth = e.target.value; // 例: "2025-10"
    await totalkakei(selectedMonth);
    await loadkoteikakei(selectedMonth);
    await loadkakei(selectedMonth);
    await ensureMonthlySettledRecords(selectedMonth);
    await loadBurdenTable(selectedMonth); 
    });
    
    //前月・翌月ボタン
    document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1))
    document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1))

    function changeMonth(offset) {
      const [year, month] = monthInput.value.split('-').map(Number)
      const newDate = new Date(year, month - 1 + offset, 1)
      const newMonthStr = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`
      monthInput.value = newMonthStr
      totalkakei(newMonthStr)
      loadkoteikakei(newMonthStr)
      loadkakei(newMonthStr)
      ensureMonthlySettledRecords(newMonthStr);
      loadBurdenTable(newMonthStr);
    }

    //固定費削除ボタン
    document.getElementById('koteideleteSelected').addEventListener('click', async () => {
    const checkboxes = document.querySelectorAll('#koteiTable tbody input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
     alert('削除する行を選択してください。');
     return;
    }

    if (!confirm(`${checkboxes.length}件を削除しますか？`)) return;

    for (const cb of checkboxes) {
     const date = cb.dataset.date;
     const seq = cb.dataset.seq;
     const { error } = await supabase
      .from('kakei')
      .delete()
      .eq('date', date)
      .eq('seq', seq);

    if (error) console.error('削除エラー:', error);
   }

   message.textContent = '削除が完了しました';
   const selectedMonth = document.getElementById('datemonth').value;
   await loadkoteikakei(selectedMonth);
   await loadkakei(selectedMonth);
   await totalkakei(selectedMonth);
  });

  // 固定修正ボタン
  document.getElementById('koteieditSelected').addEventListener('click', async () => {
   const checkboxes = document.querySelectorAll('#koteiTable tbody input[type="checkbox"]:checked');

   if (checkboxes.length === 0) {
    alert('修正する行を選択してください。');
    return;
   }
   if (checkboxes.length > 1) {
    alert('修正は1件ずつ行ってください。');
    return;
   }

   const cb = checkboxes[0];
   const date = cb.dataset.date;
   const seq = cb.dataset.seq;

   editTarget = { date, seq };

   // 対応するレコードを取得
   const { data, error } = await supabase
    .from('kakeicontent')
    .select('*')
    .eq('date', date)
    .eq('seq', seq)
    .single();

   if (error) {
     console.error('取得エラー:', error);
     alert('データ取得に失敗しました。');
    return;
   }

   const row = data;

  // 各フォームに値をセット
  document.getElementById('datepicker').value = row.date || '';
  document.getElementById('text').value = row.content || '';
  document.getElementById('income').value = row.income || 0;
  document.getElementById('meal').value = row.meal || 0;
  document.getElementById('supplies').value = row.supplies || 0;
  document.getElementById('play').value = row.play || 0;
  document.getElementById('infra').value = row.infra || 0;
  document.getElementById('education').value = row.education || 0;
  document.getElementById('others').value = row.others || 0;

  // ラジオボタン
  document.getElementById('fixedCost').checked = true;

  // カテゴリ選択
  await loadCategories();
  if (row.categoryid) {
    document.getElementById('category').value = row.categoryid;
  } else {
    // categoryidがない場合は名前で逆引き
    const categoryOption = [...document.getElementById('category').options]
      .find(opt => opt.textContent === row.categoryname);
    document.getElementById('category').value = categoryOption ? categoryOption.value : '';
  }

  // 支払者選択
  if (row.payerid) {
    document.getElementById('payer').value = row.payerid;
  } else {
    const payerOption = [...document.getElementById('payer').options]
      .find(opt => opt.textContent === row.payername);
    document.getElementById('payer').value = payerOption ? payerOption.value : '';
  }

  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.textContent = '更新';
  message.textContent = '入力欄に反映しました（修正モード）';
});	

    //変動費削除ボタン
    document.getElementById('deleteSelected').addEventListener('click', async () => {
    const checkboxes = document.querySelectorAll('#kakeiTable tbody input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
     alert('削除する行を選択してください。');
     return;
    }

    if (!confirm(`${checkboxes.length}件を削除しますか？`)) return;

    for (const cb of checkboxes) {
     const date = cb.dataset.date;
     const seq = cb.dataset.seq;
     const { error } = await supabase
      .from('kakei')
      .delete()
      .eq('date', date)
      .eq('seq', seq);

    if (error) console.error('削除エラー:', error);
   }

   message.textContent = '削除が完了しました';
   const selectedMonth = document.getElementById('datemonth').value;
   await loadkoteikakei(selectedMonth);
   await loadkakei(selectedMonth);
   await totalkakei(selectedMonth);
  });
  
  // 変動費修正ボタン
  document.getElementById('editSelected').addEventListener('click', async () => {
   const checkboxes = document.querySelectorAll('#kakeiTable tbody input[type="checkbox"]:checked');

   if (checkboxes.length === 0) {
    alert('修正する行を選択してください。');
    return;
   }
   if (checkboxes.length > 1) {
    alert('修正は1件ずつ行ってください。');
    return;
   }

   const cb = checkboxes[0];
   const date = cb.dataset.date;
   const seq = cb.dataset.seq;

   editTarget = { date, seq };

   // 対応するレコードを取得
   const { data, error } = await supabase
    .from('kakeicontent')
    .select('*')
    .eq('date', date)
    .eq('seq', seq)
    .single();

   if (error) {
     console.error('取得エラー:', error);
     alert('データ取得に失敗しました。');
    return;
   }

   const row = data;

  // 各フォームに値をセット
  document.getElementById('datepicker').value = row.date || '';
  document.getElementById('text').value = row.content || '';
  document.getElementById('income').value = row.income || 0;
  document.getElementById('meal').value = row.meal || 0;
  document.getElementById('supplies').value = row.supplies || 0;
  document.getElementById('play').value = row.play || 0;
  document.getElementById('infra').value = row.infra || 0;
  document.getElementById('education').value = row.education || 0;
  document.getElementById('others').value = row.others || 0;

  // ラジオボタン
  document.getElementById('variableCost').checked = true;
  variableCost

  // カテゴリ選択
  await loadCategories();
  if (row.categoryid) {
    document.getElementById('category').value = row.categoryid;
  } else {
    // categoryidがない場合は名前で逆引き
    const categoryOption = [...document.getElementById('category').options]
      .find(opt => opt.textContent === row.categoryname);
    document.getElementById('category').value = categoryOption ? categoryOption.value : '';
  }

  // 支払者選択
  if (row.payerid) {
    document.getElementById('payer').value = row.payerid;
  } else {
    const payerOption = [...document.getElementById('payer').options]
      .find(opt => opt.textContent === row.payername);
    document.getElementById('payer').value = payerOption ? payerOption.value : '';
  }

  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.textContent = '更新';
  message.textContent = '入力欄に反映しました（修正モード）';
});
  
  
    
    // 家計簿登録処理
    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      
      const date = document.getElementById('datepicker').value.trim()
      const categoryid = document.getElementById('category').value
      const content = document.getElementById('text').value.trim()
      const payerid = document.getElementById('payer').value
      const income = Number(document.getElementById('income').value)
      const meal = Number(document.getElementById('meal').value)
      const supplies = Number(document.getElementById('supplies').value)
      const play = Number(document.getElementById('play').value)
      const infra = Number(document.getElementById('infra').value)
      const education = Number(document.getElementById('education').value)
      const others = Number(document.getElementById('others').value)
      
      //ラジオボタン選択チェック
      const costType = document.querySelector('input[name="costType"]:checked')?.value;
       if (!costType) {
        message.textContent = 'エラー：変動費または固定費を選択してください。';
        return;
       }
      const fixedcostflg = costType === 'fixed' ? 2 : 1;
     
      // 固定費の場合、カテゴリ未設定を禁止
      if (fixedcostflg === 2 && (!categoryid || categoryid.trim() === "")) {
       message.textContent = "エラー：固定費のときはカテゴリを選択してください。";
       return;
      }
     
      // 固定費重複チェック
      if (fixedcostflg === 2) {
       const dateObj = new Date(date);
       const year = dateObj.getFullYear();
       const month = String(dateObj.getMonth() + 1).padStart(2, '0');
       const monthStart = `${year}-${month}-01`;
       const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];

       const { data: duplicateCheck, error: dupError } = await supabase
        .from('kakei')
        .select('date, categoryid')
        .eq('fixedcostflg', 2)
        .eq('categoryid', categoryid)
        .gte('date', monthStart)
        .lte('date', monthEnd);

       if (dupError) {
        console.error(dupError);
        message.textContent = '重複チェックエラー: ' + dupError.message;
        return;
       }

       if (duplicateCheck && duplicateCheck.length > 0) {
        message.textContent = 'エラー：同じ月に同じカテゴリの固定費は登録できません。';
        return;
       }
      }
     
      
      // 金額がすべて空かチェック
      if (
       income === 0 &&
       meal === 0 &&
       supplies === 0 &&
       play === 0 &&
       infra === 0 &&
       education === 0 &&
       others === 0
      ) {
       message.textContent = 'エラー：いずれかの金額を入力してください。';
       return; // 登録処理を中止
      }
      
     // 更新モードか新規モードか判定
     if (editTarget) {
      const { date: oldDate, seq } = editTarget;
      const { error } = await supabase
       .from('kakei')
       .update({ date, categoryid, content, payerid, income, meal, supplies, play, infra, education, others, fixedcostflg })
       .eq('date', oldDate)
       .eq('seq', seq);

     if (error) {
       message.textContent = '更新エラー: ' + error.message;
     } else {
       message.textContent = '更新しました！';
       editTarget = null;
       form.querySelector('button[type="submit"]').textContent = '登録';
     }
    } else {
    //新規登録
    const nextId = await getNextIdForDate(date);
    const fixedcostflg = await getfixedcostflg();
    const { error } = await supabase
      .from('kakei')
      .insert([{ date, seq: nextId, categoryid, content, payerid, income, meal, supplies, play, infra, education, others, fixedcostflg:fixedcostflg }]);

    if (error) {
      message.textContent = '追加エラー: ' + error.message;
    } else {
      message.textContent = '追加しました！';
    }
  }

  // 再表示
  const dateObj = new Date(date);
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const updateMonthStr = `${y}-${m}`;
  await totalkakei(updateMonthStr);
  await loadkoteikakei(updateMonthStr);
  await loadkakei(updateMonthStr);
  form.reset();
  loadCategories();
    })
   
  // クリアボタン 
  document.getElementById('clearButton').addEventListener('click', () => {
   document.getElementById('variableCost').checked = true;
   form.reset();
  });
    
  </script>
  <script src="./today.js"></script>
</body>
</html>