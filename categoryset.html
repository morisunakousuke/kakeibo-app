<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カテゴリメンテナンス</title>
</head>

<style>
  .form {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 8px 12px;
    max-width: 400px;
    margin-bottom: 20px;
  }
  .form label { text-align: right; }
  table { border-collapse: collapse; width: 400px; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 6px 12px; text-align: left; }
  th.checkbox, td.checkbox { text-align: center; width: 40px; }
  
  input.small {
    width: 50px; /* 幅を狭める */
  }
</style>

<body>
  <h1>カテゴリメンテナンス</h1>
  
  <!-- 変動費・固定費ラジオボタン -->
   <label><input type="radio" name="categoryType" id="variableCategory" value="variable" checked> 変動費用</label>
   <label><input type="radio" name="categoryType" id="fixedCategory" value="fixed"> 固定費用</label>

  <form id="categoryForm" class="form">
    <label for="categoryid">カテゴリID</label>
    <input id="categoryid" type="text" name="categoryid" class="small">

    <label for="categoryname">カテゴリ名</label>
    <input type="text" id="categoryname">

    <button type="submit">登録</button>
  </form>

  <p id="message"></p>

  <h2>カテゴリ一覧</h2>
  <button id="deleteBtn">選択行を削除</button>
  <table id="categoryTable">
    <thead>
      <tr>
        <th class="checkbox">✓</th>
        <th>ID</th>
        <th>カテゴリ名</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="location.href='./top.html'">入力画面に戻る</button>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://gyogtttxgenbgpryclcr.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5b2d0dHR4Z2VuYmdwcnljbGNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDYxMDEsImV4cCI6MjA3NjUyMjEwMX0.MUemu4Y1Qu4Zm0aN29dwNoLg2n51VorJvxTeaf62Pvw'
    const supabase = createClient(supabaseUrl, supabaseKey)
    
    const form = document.getElementById('categoryForm')
    const message = document.getElementById('message')
    const tableBody = document.querySelector('#categoryTable tbody')
    const deleteBtn = document.getElementById('deleteBtn')

    // カテゴリID初期表示
    async function loadNextId() {
    
    let count, error;
    
     if (document.getElementById('variableCategory').checked === true) {
      ({ count, error } = await supabase
        .from('category')
        .select('categoryid', { count: 'exact', head: true }));
     } else if (document.getElementById('fixedCategory').checked === true) {
      ({ count, error } = await supabase
        .from('infra_category')
        .select('categoryid', { count: 'exact', head: true }));
     }
     
      if (error) {
        console.error(error)
        message.textContent = 'エラーが発生しました: ' + error.message
        return;
      } 
      
      const nextId = count + 1;
      
     if (document.getElementById('variableCategory').checked === true) {
      document.getElementById('categoryid').value = String(nextId).padStart(3, '0');
     } else if (document.getElementById('fixedCategory').checked === true) {
      document.getElementById('categoryid').value = '9'+String(nextId).padStart(2, '0');
     }
    }

    // カテゴリ一覧表示
    async function loadTable() {
     let data, error;
     if (document.getElementById('variableCategory').checked === true) {
      ({ data, error } = await supabase
        .from('category')
        .select('*')
        .order('categoryid', { ascending: true }));
       } else if (document.getElementById('fixedCategory').checked === true) {
      ({ data, error } = await supabase
        .from('infra_category')
        .select('*')
       .order('categoryid', { ascending: true }));
      }

     if (error) {
        console.error(error)
        message.textContent = 'テーブル読み込みエラー: ' + error.message
        return;
      }

      tableBody.innerHTML = '';

    // ラジオボタン切り替え時に再読み込み
    document.querySelectorAll('input[name="categoryType"]').forEach(radio => {
     radio.addEventListener('change', async () => {
      await loadNextId();
      await loadTable();
     });
    });

      data.forEach(row => {
        const tr = document.createElement('tr');

        // チェックボックス
        const tdCheck = document.createElement('td');
        tdCheck.className = 'checkbox';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = row.categoryid; // 削除用
        tdCheck.appendChild(checkbox);

        // ID
        const tdId = document.createElement('td');
        tdId.textContent = String(row.categoryid).padStart(2, '0');

        // カテゴリ名
        const tdName = document.createElement('td');
        tdName.textContent = row.categoryname;

        tr.appendChild(tdCheck);
        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tableBody.appendChild(tr);
      });
    }

    // ページ初期表示
    async function init() {
      await loadNextId();
      await loadTable();
    }

    init();

    // フォーム送信
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const categoryid = document.getElementById('categoryid').value;
      const categoryname = document.getElementById('categoryname').value.trim();

      if (!categoryname) {
       message.textContent = 'カテゴリ名を入力してください。';
       return;
      }

      if (!/^\d{3}$/.test(categoryid)) {
       message.textContent = 'カテゴリIDは3桁の数値で入力してください（例: 001）';
       return;
      }

      //カテゴリIDチェック
      if (document.getElementById('variableCategory').checked === true && /^9/.test(categoryid)) {
       message.textContent = '変動費用のカテゴリIDは9から始めることはできません。';
       return;
      }

      if (document.getElementById('fixedCategory').checked === true && !/^9/.test(categoryid)) {
       message.textContent = '固定費用のカテゴリIDは9から始まる必要があります。';
       return;
      }

      
      let data, error;
      
      if (document.getElementById('variableCategory').checked === true) {
        ({ data, error } = await supabase
         .from('category')
         .insert([{ categoryid: categoryid, categoryname: categoryname }]));
      } else if (document.getElementById('fixedCategory').checked === true) { 
        ({ data, error } = await supabase
         .from('infra_category')
         .insert([{ categoryid: categoryid, categoryname: categoryname }]));
      }
         
      if (error) {
        console.error(error)
        message.textContent = '追加エラー: ' + error.message
      } else {
        message.textContent = '追加しました！';
        document.getElementById('categoryname').value = '';
        await loadNextId();
        await loadTable();
      }
    });

    // 選択行削除
    deleteBtn.addEventListener('click', async () => {
      const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]:checked');
      if (checkboxes.length === 0) return;

      const idsToDelete = Array.from(checkboxes).map(cb => cb.value);

      let data, error;
      
      if (document.getElementById('variableCategory').checked === true) {
       const { error } = await supabase
        .from('category')
        .delete()
        .in('categoryid', idsToDelete);
      } else if (document.getElementById('fixedCategory').checked === true) { 
       const { error } = await supabase
        .from('infra_category')
        .delete()
        .in('categoryid', idsToDelete);
      }

      if (error) {
        console.error(error)
        message.textContent = '削除エラー: ' + error.message
      } else {
        message.textContent = '削除しました！';
        await loadNextId();
        await loadTable();
      }
    });
  </script>
</body>
</html>
